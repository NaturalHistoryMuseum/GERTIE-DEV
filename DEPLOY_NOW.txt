# DEPLOYMENT via sync_to_slaves.sh ONLY

Date: 2025-11-11
Commits: 
  - d100864 Fix: Add raw sensor parameter to prevent letterbox cropping in still captures
  - 1f59acd Sync: Add raw sensor parameter to still_capture_offline.py (prevents letterboxing)
  - a826026 Fix: WYSIWYG crop scaling - scale crop coordinates from video resolution to still resolution

## TWO CRITICAL FIXES FOR IMAGE CAPTURE

### FIX #1: LETTERBOX CROPPING RESOLVED

**Problem Fixed:**
Final captured images had black bars (letterboxing) at top/bottom.

**Root Cause:**
- Picamera2 create_still_configuration() was missing `raw` parameter
- Without explicit sensor config, Picamera2 auto-selected sensor mode
- Auto-selected mode caused letterboxing when scaled to requested resolution

**Solution Applied:**
Added `raw={"size": (4608, 2592)}` to force full HQ sensor usage in:
- slave/still_capture.py (line 247-252)
- slave/still_capture_offline.py (line 311-316)

This matches the working pattern from video_stream.py.

### FIX #2: WYSIWYG CROP SYNCHRONIZATION

**Problem Fixed:**
Crop adjustments in video preview didn't match the crop in final captured still images.

**Root Cause:**
- Video stream preview: 640x480 resolution (user adjusts crop based on this)
- Still capture: 4608x2592 resolution (full sensor)
- Crop coordinates designed for 640x480 were applied directly to 4608x2592
- Result: Wrong crop region in still images (not matching preview)

**Solution Applied:**
Added resolution-aware crop scaling in shared/transforms.py:
- New function: apply_crop_scaled_for_still() (lines 231-283)
- Calculates scale factors: X = 4608/640 = 7.2, Y = 2592/480 = 5.4
- Scales crop coordinates proportionally before applying
- Result: What you see in preview = what you get in capture (WYSIWYG)

**Example:**
- User sees crop at x=100, y=50, w=400, h=300 in 640x480 preview
- System now scales to x=720, y=270, w=2880, h=1620 for 4608x2592 capture
- Final image matches preview exactly

## MANDATORY DEPLOYMENT STEPS (NO ALTERNATIVES):

1. Copy camera_system_integrated_final to USB drive
   
2. On control1 Pi:
   cp -r /media/USB/camera_system_integrated_final /home/andrc1/
   
3. Navigate to project:
   cd /home/andrc1/camera_system_integrated_final
   
4. Deploy to all cameras:
   ./sync_to_slaves.sh
   
5. Start system:
   ./run_gui_with_logging.sh
   
6. Test BOTH fixes:
   
   **Test A - Letterboxing Fix:**
   - Capture still images from multiple cameras
   - Verify images are full frame (4608x2592)
   - Verify NO letterboxing (no black bars)
   - Check captured_images folder on each Pi
   
   **Test B - WYSIWYG Crop:**
   - Enable crop in GUI
   - Adjust crop rectangle in video preview
   - Capture still image
   - Verify captured image has EXACT same crop as preview
   - Try different crop positions/sizes
   
7. Collect logs:
   cp /home/andrc1/Desktop/updatelog.txt /media/USB/
   
8. Return updatelog.txt to MacBook for analysis

## Expected Results:

**Letterboxing Fix:**
- Still captures use full sensor (4608x2592)
- No letterboxing or black bars
- Images fill entire frame
- All 8 cameras capture correctly

**WYSIWYG Crop:**
- Preview shows exact crop that will be captured
- Crop coordinates scale properly from video to still resolution
- What you see = what you get (WYSIWYG)
- Consistent cropping across all cameras

## Technical Details:

**Fix #1 (Letterboxing):**
Before:
  still_config = picam2.create_still_configuration(
      main={"size": (4608, 2592)}
  )

After:
  still_config = picam2.create_still_configuration(
      main={"size": (4608, 2592)},
      raw={"size": (4608, 2592)}  # Force full sensor
  )

**Fix #2 (WYSIWYG Crop):**
Before:
  # Applied video crop coords directly to still (WRONG!)
  image = apply_crop_rgb(image, settings)

After:
  # Scale crop coordinates for resolution difference
  scale_x = still_width / video_width  # e.g., 4608/640 = 7.2
  scale_y = still_height / video_height  # e.g., 2592/480 = 5.4
  scaled_x = crop_x * scale_x
  scaled_y = crop_y * scale_y
  # ... apply scaled crop

## DO NOT:
- Use any other deployment method
- Run individual scp commands  
- Modify sync_to_slaves.sh
- Skip testing steps (both fixes need verification)
